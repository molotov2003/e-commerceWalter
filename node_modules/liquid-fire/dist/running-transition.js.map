{"version":3,"file":"running-transition.js","sources":["../src/running-transition.js"],"sourcesContent":["import { capitalize } from '@ember/string';\r\n\r\nexport default class RunningTransition {\r\n  constructor(transitionMap, versions, animation) {\r\n    this.transitionMap = transitionMap;\r\n    this.animation = animation || transitionMap.lookup('default');\r\n    this.animationContext = publicAnimationContext(this, versions);\r\n  }\r\n\r\n  run() {\r\n    if (this._ran) {\r\n      return this._ran;\r\n    }\r\n\r\n    this.transitionMap.incrementRunningTransitions();\r\n    return (this._ran = this._invokeAnimation()\r\n      .catch((err) => {\r\n        // If the animation blew up, try to leave the DOM in a\r\n        // non-broken state as best we can before rethrowing.\r\n        return this.transitionMap\r\n          .lookup('default')\r\n          .apply(this.animationContext)\r\n          .then(function () {\r\n            throw err;\r\n          });\r\n      })\r\n      .finally(() => {\r\n        this.transitionMap.decrementRunningTransitions();\r\n      }));\r\n  }\r\n\r\n  interrupt() {\r\n    this.interrupted = true;\r\n    this.animationContext.oldElement = null;\r\n    this.animationContext.newElement = null;\r\n    this.animationContext.older.forEach((entry) => {\r\n      entry.element = null;\r\n    });\r\n  }\r\n\r\n  _invokeAnimation() {\r\n    return this.animation.run(this.animationContext).then(() => {\r\n      return this.interrupted;\r\n    });\r\n  }\r\n}\r\n\r\n// This defines the public set of things that user's transition\r\n// implementations can access as `this`.\r\nfunction publicAnimationContext(rt, versions) {\r\n  const c = {};\r\n  addPublicVersion(c, 'new', versions[0]);\r\n  if (versions[1]) {\r\n    addPublicVersion(c, 'old', versions[1]);\r\n  }\r\n  c.older = versions.slice(2).map((v) => {\r\n    const context = {};\r\n    addPublicVersion(context, null, v);\r\n    return context;\r\n  });\r\n\r\n  // Animations are allowed to look each other up.\r\n  c.lookup = function (name) {\r\n    return rt.transitionMap.lookup(name);\r\n  };\r\n\r\n  return c;\r\n}\r\n\r\nfunction addPublicVersion(context, prefix, version) {\r\n  let elt = null;\r\n\r\n  if (version.view) {\r\n    elt = version.view.element;\r\n  }\r\n\r\n  const props = {\r\n    view: version.view,\r\n    element: elt,\r\n    value: version.value,\r\n  };\r\n  for (const key in props) {\r\n    let outputKey = key;\r\n    if (Object.hasOwnProperty.call(props, key)) {\r\n      if (prefix) {\r\n        outputKey = prefix + capitalize(key);\r\n      }\r\n      context[outputKey] = props[key];\r\n    }\r\n  }\r\n}\r\n"],"names":["RunningTransition","constructor","transitionMap","versions","animation","lookup","animationContext","publicAnimationContext","run","_ran","incrementRunningTransitions","_invokeAnimation","catch","err","apply","then","finally","decrementRunningTransitions","interrupt","interrupted","oldElement","newElement","older","forEach","entry","element","rt","c","addPublicVersion","slice","map","v","context","name","prefix","version","elt","view","props","value","key","outputKey","Object","hasOwnProperty","call","capitalize"],"mappings":"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"}