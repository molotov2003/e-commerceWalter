{"version":3,"file":"index.js","sources":["../../lib/encoder.ts"],"sourcesContent":["import type {\n  CompilerBuffer,\n  InstructionEncoder,\n  MACHINE_MASK,\n  Operand,\n  SomeVmOp,\n  VmMachineOp,\n  VmOp,\n} from '@glimmer/interfaces';\nimport { ARG_SHIFT, MAX_SIZE, TYPE_SIZE } from '@glimmer/vm';\n\nexport class InstructionEncoderImpl implements InstructionEncoder {\n  constructor(readonly buffer: CompilerBuffer) {}\n\n  size = 0;\n\n  encode(type: VmMachineOp, machine: MACHINE_MASK, ...operands: Operand[]): void;\n  encode(type: VmOp, machine: 0, ...operands: Operand[]): void;\n  encode(type: SomeVmOp, machine: 0 | MACHINE_MASK, ...args: Operand[]) {\n    if ((type as number) > TYPE_SIZE) {\n      throw new Error(`Opcode type over 8-bits. Got ${type}.`);\n    }\n\n    let first = type | machine | ((arguments.length - 2) << ARG_SHIFT);\n\n    this.buffer.push(first);\n\n    for (const op of args) {\n      if (import.meta.env.DEV && typeof op === 'number' && op > MAX_SIZE) {\n        throw new Error(`Operand over 32-bits. Got ${op}.`);\n      }\n      this.buffer.push(op);\n    }\n\n    this.size = this.buffer.length;\n  }\n\n  patch(position: number, target: number) {\n    if (this.buffer[position + 1] === -1) {\n      this.buffer[position + 1] = target;\n    } else {\n      throw new Error('Trying to patch operand in populated slot instead of a reserved slot.');\n    }\n  }\n}\n"],"names":["InstructionEncoderImpl","constructor","buffer","this","size","encode","type","machine","_len","arguments","length","args","Array","_key","TYPE_SIZE","Error","first","ARG_SHIFT","push","op","MAX_SIZE","patch","position","target"],"mappings":"qEAWO,MAAMA,EACXC,WAAAA,CAAqBC,GAAwBC,KAAxBD,OAAAA,CAAyB,CAE9CE,KAAO,EAIPC,MAAAA,CAAOC,EAAgBC,GAA+C,IAAAC,IAAAA,EAAAC,UAAAC,OAAjBC,MAAIC,MAAAJ,EAAAA,EAAAA,OAAAK,EAAA,EAAAA,EAAAL,EAAAK,IAAJF,EAAIE,EAAAJ,GAAAA,UAAAI,GACvD,GAAKP,EAAkBQ,EACrB,MAAM,IAAIC,MAAO,gCAA+BT,MAGlD,IAAIU,EAAQV,EAAOC,EAAYE,UAAUC,OAAS,GAAMO,EAExDd,KAAKD,OAAOgB,KAAKF,GAEjB,IAAK,MAAMG,KAAMR,EAAM,CACrB,GAAyC,iBAAPQ,GAAmBA,EAAKC,EACxD,MAAM,IAAIL,MAAO,6BAA4BI,MAE/ChB,KAAKD,OAAOgB,KAAKC,EACnB,CAEAhB,KAAKC,KAAOD,KAAKD,OAAOQ,MAC1B,CAEAW,KAAAA,CAAMC,EAAkBC,GACtB,IAAmC,IAA/BpB,KAAKD,OAAOoB,EAAW,GAGzB,MAAM,IAAIP,MAAM,yEAFhBZ,KAAKD,OAAOoB,EAAW,GAAKC,CAIhC"}